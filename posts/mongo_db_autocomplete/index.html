<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Ellaborate case Before starting with set up and everything, I would love to confess that I find Mongodb and Python combination as pain in the ass. Recently I have got an job offer as Python/Flask developer in one of the local companies in my country. They are using Mongodb as their production database. They requested a little bit of task to accomplish before we move on to HR interview. So the task was about coding autocomplete search logic and also finding the closest location to our current location from the database."><meta name=keywords content="Yalchin Mammadli Software Developer Python Golang Node.js,Python,Mongodb,Databases"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=/posts/mongo_db_autocomplete/><title>Accent and Case Insensitive Search and Minimum Distance Calculator in Pymongo :: Yalchin's Blog — Notes about the things I learn</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.4e5c639214707eff609bb55fe49e183dee42258a73bc90e4cc7b0a84f900798a.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Accent and Case Insensitive Search and Minimum Distance Calculator in Pymongo"><meta itemprop=description content="Ellaborate case Before starting with set up and everything, I would love to confess that I find Mongodb and Python combination as pain in the ass. Recently I have got an job offer as Python/Flask developer in one of the local companies in my country. They are using Mongodb as their production database. They requested a little bit of task to accomplish before we move on to HR interview. So the task was about coding autocomplete search logic and also finding the closest location to our current location from the database."><meta itemprop=datePublished content="2022-04-28T14:22:27+04:00"><meta itemprop=dateModified content="2022-04-28T14:22:27+04:00"><meta itemprop=wordCount content="796"><meta itemprop=keywords content="Python,Mongodb,Databases,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Accent and Case Insensitive Search and Minimum Distance Calculator in Pymongo"><meta name=twitter:description content="Ellaborate case Before starting with set up and everything, I would love to confess that I find Mongodb and Python combination as pain in the ass. Recently I have got an job offer as Python/Flask developer in one of the local companies in my country. They are using Mongodb as their production database. They requested a little bit of task to accomplish before we move on to HR interview. So the task was about coding autocomplete search logic and also finding the closest location to our current location from the database."><meta property="article:published_time" content="2022-04-28 14:22:27 +0400 +0400"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>Hello, Friend</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/posts>Blog</a></li><li><a href=/personal/contact>Contact</a></li><li><a href=/resume/cv.pdf>Resume</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 minutes</p></div><article><h1 class=post-title><a href=/posts/mongo_db_autocomplete/>Accent and Case Insensitive Search and Minimum Distance Calculator in Pymongo</a></h1><figure class=post-cover><img src=/blog-images/pymongo.jpeg alt="Accent and Case Insensitive Search and Minimum Distance Calculator in Pymongo"></figure><div class=post-content><h1 id=ellaborate-case>Ellaborate case</h1><p>Before starting with set up and everything, I would love to confess that I find Mongodb and Python combination as <strong>pain in the ass</strong>. Recently I have got an job offer as Python/Flask developer in one of the local companies in my country. They are using Mongodb as their production database. They requested a little bit of task to accomplish before we move on to HR interview. So the task was about coding autocomplete search logic and also finding the closest location to our current location from the database. Task seems interesting and pretty much easy to solve, at least for me as a Django developer who have used Postgresql as default database in most of the cases. However, seemed like things don&rsquo;t go so well with Mongodb in django. It seemed like if Python is envolved, we normally have two pypi packages two use, namely <a href=https://pymongo.readthedocs.io/en/stable/>pymongo</a> and <a href=https://docs.mongoengine.org/>mongoengine</a>. I was familiar with pymongo as in my <a href=https://t.me/mp3converteryoutubebot>telegram bot</a> I use Mongodb as database and use pymongo to implement database actions. Hence, below I will explain how I implemented case and accent insensitive search and minimum distance finding via pymongo.</p><hr><h1 id=database-setup>Database setup</h1><p>First we need to make sure we have all the dependencies to be able to run our Python modules successfully, I will name then, and also drop my requirements.txt content as well:</p><p>Dependencies:</p><ul><li>pymongo</li><li>sqlparse</li><li>geographiclib</li><li>geopy</li></ul><p>Here is the content of <code>requirements.txt</code> which you can use by running <code>pip install -r requirements.txt</code>:</p><pre tabindex=0><code>backports.zoneinfo==0.2.1
geographiclib==1.52
geopy==2.2.0
pymongo==4.1.1
python-dotenv==0.20.0
sqlparse==0.2.4
</code></pre><p>Now, you can create local database or use <a href=https://cloud.mongodb.com>Mongodb atlas</a> which I personally prefered. Create database, and also get your <code>URI</code> which you will use to connect to your database via utilizing pymongo. You can watch <a href="https://www.youtube.com/watch?v=VQnmcBnguPY">this</a> video if you don&rsquo;t know how to set up remote mongodb database and configure connection via pymongo. If you want to keep your atlas account safe, do not include <code>URI</code> inside your project direcly but use <code>env</code> and some library like <a href=https://pypi.org/project/python-dotenv/>python-dotenv</a> to load <code>.env</code> content into os enviroment variables. Here is my database set up that you can use:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#5bc4bf>from</span> <span style=color:#fec418>dotenv</span> <span style=color:#5bc4bf>import</span> load_dotenv
</span></span><span style=display:flex><span><span style=color:#5bc4bf>import</span> <span style=color:#fec418>os</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>from</span> <span style=color:#fec418>pymongo</span> <span style=color:#5bc4bf>import</span> MongoClient
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>load_dotenv()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DATABASE_URI <span style=color:#5bc4bf>=</span> os<span style=color:#5bc4bf>.</span>getenv(<span style=color:#48b685>&#34;DATABASE_URI&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client <span style=color:#5bc4bf>=</span> MongoClient(DATABASE_URI)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client <span style=color:#5bc4bf>=</span> MongoClient(DATABASE_URI)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>db <span style=color:#5bc4bf>=</span> client<span style=color:#5bc4bf>.</span>get_database(<span style=color:#48b685>&#39;autocompletedb&#39;</span>) <span style=color:#776e71># here autocompletedb is the name of database</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># This is added so that many files can reuse the function get_database()</span>
</span></span><span style=display:flex><span>addresses_table <span style=color:#5bc4bf>=</span> db<span style=color:#5bc4bf>.</span>addresses <span style=color:#776e71># here the addresses is the name of table inside autocomplete database</span>
</span></span></code></pre></div><hr><h1 id=minimum-distance-calculation>Minimum distance calculation</h1><p>MongoDB supports query operations on geospatial data so we can take advantage of this functionality without writing our own formula two calculate minimum distance between two coordinates containing latitude and longitude. I found <a href=https://towardsdatascience.com/finding-distance-between-two-latitudes-and-longitudes-in-python-43e92d6829ff>this</a> very interesting if you are interested in the math side of the case. If not, you can use below snippet:</p><p>First ensure that you have a proper index in the database:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#5bc4bf>from</span> <span style=color:#fec418>pymongo</span> <span style=color:#5bc4bf>import</span> MongoClient, GEOSPHERE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client <span style=color:#5bc4bf>=</span> MongoClient()
</span></span><span style=display:flex><span>collection <span style=color:#5bc4bf>=</span> db[<span style=color:#48b685>&#39;COLLECTION_NAME&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># create index</span>
</span></span><span style=display:flex><span>collection<span style=color:#5bc4bf>.</span>create_index([(<span style=color:#48b685>&#39;geo&#39;</span>, GEOSPHERE)])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># store GPS coordinates in db</span>
</span></span></code></pre></div><p>And make sure you keep your latitude and longitude that way:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>lat <span style=color:#5bc4bf>=</span> <span style=color:#5bc4bf>...</span>
</span></span><span style=display:flex><span>lon <span style=color:#5bc4bf>=</span> <span style=color:#5bc4bf>...</span>
</span></span><span style=display:flex><span>item <span style=color:#5bc4bf>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#48b685>&#39;geo&#39;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#48b685>&#39;type&#39;</span>: <span style=color:#48b685>&#34;Point&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#48b685>&#39;coordinates&#39;</span>: [lon, lat]
</span></span><span style=display:flex><span>  }  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>collection<span style=color:#5bc4bf>.</span>insert_one(item)  
</span></span></code></pre></div><p>As you have index and proper data in place, you can start retrieving it:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#815ba4>def</span> <span style=color:#06b6ef>calculate_distance</span>(coordinates):
</span></span><span style=display:flex><span>    latitude, longitude <span style=color:#5bc4bf>=</span> coordinates
</span></span><span style=display:flex><span>    items <span style=color:#5bc4bf>=</span> addresses_table<span style=color:#5bc4bf>.</span>find({<span style=color:#48b685>&#39;geo&#39;</span>: {<span style=color:#48b685>&#34;$nearSphere&#34;</span>: [latitude, longitude], <span style=color:#48b685>&#34;$maxDistance&#34;</span>: <span style=color:#f99b15>5000</span>}})
</span></span><span style=display:flex><span>    <span style=color:#815ba4>for</span> item <span style=color:#5bc4bf>in</span> items:
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> item
</span></span></code></pre></div><p>This will take coordinates as tuple and from the database and find the coordinates with minimum distance relative to the given coordinates (<code>max_distance = 5 km</code>)</p><h1 id=accent-and-case-insensitive-search>Accent and Case Insensitive Search</h1><p>This part was a bit tricky, as I couldn&rsquo;t make the accent insensitive search work using different function shown in the documentation, they somehow didn&rsquo;t work properly. I used regular expression with <code>i</code> option to ignore case sensitivity and searched for the given keywork from different fields in my collection. Additionally to consider accent, based on keyword, I created other versions of the keyword (considering accent). For example if someone searchs for Helen, I will be searching for both <code>Helen</code> and <code>Hélen</code> and vice versa. Below its implemnetation is given:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#815ba4>def</span> <span style=color:#06b6ef>normalize_keyword</span>(keyword):
</span></span><span style=display:flex><span>  keyword <span style=color:#5bc4bf>=</span> keyword<span style=color:#5bc4bf>.</span>lower()
</span></span><span style=display:flex><span>  variants <span style=color:#5bc4bf>=</span> {<span style=color:#48b685>&#39;ə&#39;</span>: [<span style=color:#48b685>&#39;e&#39;</span>, <span style=color:#48b685>&#39;a&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;ı&#39;</span>: [<span style=color:#48b685>&#39;i&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;ç&#39;</span>: [<span style=color:#48b685>&#39;c&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;ş&#39;</span>: [<span style=color:#48b685>&#39;s&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;ö&#39;</span>: [<span style=color:#48b685>&#39;o&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;ğ&#39;</span>: [<span style=color:#48b685>&#39;g&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;e&#39;</span>: [<span style=color:#48b685>&#39;ə&#39;</span>, <span style=color:#48b685>&#39;a&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;a&#39;</span>: [<span style=color:#48b685>&#39;ə&#39;</span>, <span style=color:#48b685>&#39;e&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;i&#39;</span>: [<span style=color:#48b685>&#39;ı&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;c&#39;</span>: [<span style=color:#48b685>&#39;ç&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;s&#39;</span>: [<span style=color:#48b685>&#39;ş&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;o&#39;</span>: [<span style=color:#48b685>&#39;ö&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#48b685>&#39;g&#39;</span>: [<span style=color:#48b685>&#39;ğ&#39;</span>]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  possibilities <span style=color:#5bc4bf>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#815ba4>for</span> letter <span style=color:#5bc4bf>in</span> keyword:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> letter <span style=color:#5bc4bf>in</span> variants:
</span></span><span style=display:flex><span>      substitutes <span style=color:#5bc4bf>=</span> variants[letter]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#815ba4>for</span> substitute <span style=color:#5bc4bf>in</span> substitutes:
</span></span><span style=display:flex><span>        possibilities<span style=color:#5bc4bf>.</span>append(keyword<span style=color:#5bc4bf>.</span>replace(letter, substitute))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  possibilities <span style=color:#5bc4bf>=</span> set(possibilities)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#815ba4>return</span> possibilities
</span></span></code></pre></div><p>As mentioned with the help of above function and regex search we implement the search funcionality:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#815ba4>def</span> <span style=color:#06b6ef>apply_multiple_filters</span>(keywords):
</span></span><span style=display:flex><span>    keywords <span style=color:#5bc4bf>=</span> normalize_keyword(keywords)
</span></span><span style=display:flex><span>    results <span style=color:#5bc4bf>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>for</span> keyword <span style=color:#5bc4bf>in</span> keywords:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        results<span style=color:#5bc4bf>.</span>append(addresses_table<span style=color:#5bc4bf>.</span>find({<span style=color:#48b685>&#39;$or&#39;</span>: [
</span></span><span style=display:flex><span>                            {<span style=color:#48b685>&#39;city&#39;</span>: {<span style=color:#48b685>&#39;$regex&#39;</span>: keyword, <span style=color:#48b685>&#39;$options&#39;</span>: <span style=color:#48b685>&#39;i&#39;</span>}},
</span></span><span style=display:flex><span>                            {<span style=color:#48b685>&#39;street&#39;</span>: {<span style=color:#48b685>&#39;$regex&#39;</span>: keyword, <span style=color:#48b685>&#39;$options&#39;</span>: <span style=color:#48b685>&#39;i&#39;</span>}},
</span></span><span style=display:flex><span>                            {<span style=color:#48b685>&#39;street_number&#39;</span>: {<span style=color:#48b685>&#39;$regex&#39;</span>: keyword, <span style=color:#48b685>&#39;$options&#39;</span>: <span style=color:#48b685>&#39;i&#39;</span>}}
</span></span><span style=display:flex><span>                        ]
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>        ))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> results
</span></span></code></pre></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=/tags/python/>Python</a></span>
<span class=tag><a href=/tags/mongodb/>Mongodb</a></span>
<span class=tag><a href=/tags/databases/>Databases</a></span></p><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://blog-yalchin-ml.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>796 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-04-28 10:22</p></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=/posts/first_personal_blog/><span class=button__icon>←</span>
<span class=button__text>First Personal Blog</span></a></span></div></div><div id=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//blog-yalchin-ml.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.bb2c6bc3ed452ca4759660e4020811f248bc2320081559e8a32d8b0092773852941133639d35e8370d03d3ddaa750b1edd6b343c5bd22a55d5bdeae8f648f49b.js integrity="sha512-uyxrw+1FLKR1lmDkAggR8ki8IyAIFVnooy2LAJJ3OFKUETNjnTXoNw0D092qdQse3Ws0PFvSKlXVvero9kj0mw=="></script></body></html>